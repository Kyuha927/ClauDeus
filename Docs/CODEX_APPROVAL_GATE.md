# Codex 승인 게이트 규칙 (Approval Gate Rules)

> Codex가 범위를 넓히거나 과도한 리팩터링을 수행하는 것을 방지하기 위한 운영 규칙입니다.
> `codex_extension_snapshot.md` 에 붙여 사용하세요.

---

## 1. Reasoning Effort 운영 기준

| 수준 | 언제 사용 | 예시 |
|:---|:---|:---|
| **Low** | 변수 이름 변경, 오타 수정, 주석 추가 등 기계적 작업 | `rename variable`, `fix typo` |
| **Medium** (기본) | 단일 함수/메서드 구현, 버그 수정, 단위 테스트 작성 | `implement spawnEnemy()`, `fix off-by-one` |
| **High** | 모듈간 인터페이스 수정, 새 서브시스템 설계 | `add weapon upgrade system` |
| **Extra High** | 아키텍처 변경, 3개 이상 파일에 걸친 리팩터링 | `restructure ECS pipeline` |

### ⚠ Extra High 사용 제한

Extra High는 아래 **3가지 조건을 모두 충족**할 때만 사용합니다:

1. 변경 대상 파일이 **3개 이상**이고 상호 의존성이 있음
2. 기존 인터페이스/API 시그니처가 **변경**됨
3. 사전에 **사용자 승인**을 받았음

> **위반 시**: Codex가 Extra High로 작업을 시작하면 즉시 중단하고
> "이 변경은 Extra High 범위입니다. 승인을 요청합니다." 라고 보고해야 합니다.

---

## 2. 사용자 승인 필수 변경 목록

아래 변경은 **반드시 사용자 확인 후** 진행합니다. Codex가 자의적으로 수행해서는 안 됩니다.

| 카테고리 | 구체적 행위 | 사유 |
|:---|:---|:---|
| **파일 삭제** | 기존 파일/폴더 삭제 | 롤백 불가 위험 |
| **의존성 변경** | `package.json`, `requirements.txt` 수정 | 환경 깨짐 위험 |
| **설정 변경** | CI/CD 워크플로우, `.env`, `wsl.conf` 수정 | 인프라 영향 |
| **API 변경** | 함수 시그니처, export 인터페이스 변경 | 하위 호환성 파괴 |
| **대규모 이동** | 파일 3개 이상 위치 변경 | 임포트 경로 전파 |
| **새 기술 도입** | 새 라이브러리, 프레임워크 추가 | 학습/유지보수 비용 |

---

## 3. 대규모 변경 단계 분할 규칙

변경이 **300줄 또는 10파일을 초과**할 경우, 아래 분할 프로토콜을 따릅니다:

### 3.1 분할 원칙

```
1개의 큰 변경  →  N개의 작은 커밋  →  각각 독립적으로 롤백 가능
```

### 3.2 분할 절차

| 단계 | Codex 행동 | 사용자 행동 |
|:---:|:---|:---|
| 1 | 전체 작업을 **3~5개 커밋 단위**로 분할 계획서 작성 | 계획 검토 및 승인 |
| 2 | 1번째 커밋 구현 + `./dev test` 통과 확인 | diff 리뷰 |
| 3 | 승인 시 커밋, 2번째 커밋으로 이동 | 필요 시 방향 수정 |
| 4 | 모든 커밋 완료 후 `./dev smoke` 통합 점검 | 최종 승인 |

### 3.3 커밋 단위 기준

- 각 커밋은 **독립적으로 빌드/테스트 통과** 해야 함
- 커밋 간 **의존 순서**가 있으면 명시 (예: "커밋 2는 커밋 1 이후 적용")
- 중간 커밋에서 깨지는 테스트가 있으면 **해당 커밋에서 수정** (다음 커밋으로 미루지 않음)

---

## 4. Codex 자기 점검 프롬프트

Codex가 작업 전 스스로에게 묻는 질문 (system prompt에 포함):

```
작업 시작 전 체크:
□ 이 변경은 요청된 범위 안에 있는가?
□ 요청되지 않은 리팩터링을 포함하고 있지 않은가?
□ 변경 파일이 3개를 초과하면 분할 계획을 세웠는가?
□ 기존 API/인터페이스를 변경하면 사용자 승인을 받았는가?
□ Extra High reasoning이 정말 필요한 작업인가?
```

> 하나라도 "아니오"이면 **작업을 중단**하고 사용자에게 확인을 요청합니다.
